---
Index: "[[ğŸ· Lecture Notes]]"
tags:
  - Linux
  - Linux/namespace
  - Linux/Network
---
>[!info] Link
>- [[02-12-a. ip, netns]]
>- [[ip]]


## ê°œìš”
- ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ 2ê°œ(ns0, ns1)ì„ ìƒì„±í•œë‹¤.
- root ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ë¸Œë¦¿ì§€ 1ê°œë¥¼ ìƒì„±í•œë‹¤.
- root ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œ  `veth` 2ê°œ(`veth0, veth1`)ë¥¼ ìƒì„±í•œë‹¤.
- `veth`ì˜ `peer`ë¡œ ê° ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì™€ ì—°ê²°í•  ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤`ceth0, ceth1`ë¥¼ ìƒì„±í•œë‹¤.
- `veth`ì™€ ë¸Œë¦¿ì§€ë¥¼ ì—°ê²°í•œë‹¤.
- `ceth0, ceth1`ì„ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì™€ ì—°ê²°í•œë‹¤.
- ê° ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ì— IPë¥¼ í• ë‹¹í•œë‹¤.
- ì„œë¡œ í†µì‹ ì´ ë˜ëŠ”ì§€ í™•ì¸í•œë‹¤.



## 1. ìƒˆë¡œìš´ ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„± ë° í™•ì¸
```bash
root@cgroupv1:~] ip netns add ns0
root@cgroupv1:~] ip netns add ns1
root@cgroupv1:~] ip netns list
ns0
ns1
```

## 2. root, ns0, ns1 ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‚´ ëª¨ë“  ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ì •ë³´ í™•ì¸
```bash
# root ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‚´ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ì •ë³´ í™•ì¸
root@cgroupv1:~] ip link
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
2: enX0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc fq_codel state UP mode DEFAULT group default qlen 1000
    link/ether 0a:fb:45:e2:59:21 brd ff:ff:ff:ff:ff:ff

# ns0 ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‚´ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ì •ë³´ í™•ì¸
root@cgroupv1:~] ip netns exec ns0 ip link
1: lo: <LOOPBACK> mtu 65536 qdisc noop state DOWN mode DEFAULT group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00

# ns1 ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‚´ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ì •ë³´ í™•ì¸
root@cgroupv1:~] ip netns exec ns1 ip link
1: lo: <LOOPBACK> mtu 65536 qdisc noop state DOWN mode DEFAULT group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
```


## 3. ìƒì„±í•œ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‚´ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ í™œì„±í™”(Up)
```bash
root@cgroupv1:~] ip netns exec ns0 ip link set lo up
root@cgroupv1:~] ip netns exec ns1 ip link set lo up
```


## 4. root ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‚´ Bridge ìƒì„± ë° í™œì„±í™”
```bash
# ê¸°ì¡´ ë¸Œë¦¿ì§€ ìœ í˜• ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ê°€ ìˆëŠ” ì§€ í™•ì¸
root@cgroupv1:~] ip link show type bridge

# ë¸Œë¦¿ì§€ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤(br0) ìƒì„± ë° í™œì„±í™”
root@cgroupv1:~] ip link add br0 type bridge
root@cgroupv1:~] ip link set br0 up

# ë¸Œë¦¿ì§€ ìƒì„± í™•ì¸
## IP í• ë‹¹ì´ ì•ˆëœ ìƒíƒœ
root@cgroupv1:~] ip link show type bridge
3: br0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc noqueue state DOWN mode DEFAULT group default qlen 1000
    link/ether 82:0b:be:b4:c2:65 brd ff:ff:ff:ff:ff:ff
```


## 5. root ë„¤ì„ìŠ¤í˜ì´ìŠ¤ `br`0 IP í• ë‹¹
```bash
# ë¸Œë¦¿ì§€ì— IP í• ë‹¹
root@cgroupv1:~] ip addr add 192.168.2.1/24 dev br0

# í™•ì¸
root@cgroupv1:~] ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host noprefixroute
       valid_lft forever preferred_lft forever
2: enX0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc fq_codel state UP group default qlen 1000
    link/ether 0a:fb:45:e2:59:21 brd ff:ff:ff:ff:ff:ff
    inet 172.31.45.46/20 metric 100 brd 172.31.47.255 scope global dynamic enX0
       valid_lft 1967sec preferred_lft 1967sec
    inet6 fe80::8fb:45ff:fee2:5921/64 scope link
       valid_lft forever preferred_lft forever
3: br0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc noqueue state DOWN group default qlen 1000
    link/ether 82:0b:be:b4:c2:65 brd ff:ff:ff:ff:ff:ff
    inet 192.168.2.1/24 scope global br0
       valid_lft forever preferred_lft forever

# í†µì‹  ì—¬ë¶€ í™•ì¸(ping)
root@cgroupv1:~] ping 192.168.2.1
PING 192.168.2.1 (192.168.2.1) 56(84) bytes of data.
64 bytes from 192.168.2.1: icmp_seq=1 ttl=64 time=0.012 ms
64 bytes from 192.168.2.1: icmp_seq=2 ttl=64 time=0.021 ms
64 bytes from 192.168.2.1: icmp_seq=3 ttl=64 time=0.024 ms

^C
--- 192.168.2.1 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2064ms
rtt min/avg/max/mdev = 0.012/0.019/0.024/0.005 ms
```


## 6. ns0, ns1 ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ì—°ê²°í•  `veth0 - ceth0, veth1 - ceth1` ìƒì„±
- `veth` íƒ€ì… ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ëŠ” í•­ìƒ pairë¡œ ìƒì„±í•œë‹¤.
- ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ê°„ ì—°ê²°í•  ì¼€ì´ë¸”ì„ ë§Œë“œëŠ” ê³¼ì •ì´ë‹¤.
```bash
root@cgroupv1:~] ip link add veth0 type veth peer name ceth0
root@cgroupv1:~] ip link add veth1 type veth peer name ceth1
```


## 7. `veth`ë¥¼ `br0`ì— ì—°ê²°, í™œì„±í™”
```bash
# br0ì„ ë§ˆìŠ¤í„°ë¡œ í•˜ë„ë¡ vethë¥¼ ì„¤ì •
root@cgroupv1:~] ip link set veth0 master br0
root@cgroupv1:~] ip link set veth1 master br0

# up
root@cgroupv1:~] ip link set veth0 up
root@cgroupv1:~] ip link set veth1 up
```

## 8. `ceth0, 1`ì„  `ns0, 1`ê³¼ ê°ê° ì—°ê²°, í™œì„±í™”
```bash
# cethë¥¼ nsì™€ ì—°ê²°
root@cgroupv1:~] ip link set ceth0 netns ns0
root@cgroupv1:~] ip link set ceth1 netns ns1

# up
root@cgroupv1:~] ip netns exec ns0 ip link set ceth0 up
root@cgroupv1:~] ip netns exec ns1 ip link set ceth1 up

# ns0ì— ceth0 ì—°ê²° í™•ì¸
root@cgroupv1:~] ip netns exec ns0 ip addr
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
4: ceth0@if5: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default qlen 1000
    link/ether 86:fd:92:9b:e5:c1 brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet 192.168.2.2/24 scope global ceth0
       valid_lft forever preferred_lft forever
    inet6 fe80::84fd:92ff:fe9b:e5c1/64 scope link
       valid_lft forever preferred_lft forever

# ns1ì— ceth1 ì—°ê²° í™•ì¸
root@cgroupv1:~] ip netns exec ns1 ip addr
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
6: ceth1@if7: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default qlen 1000
    link/ether 8e:82:d4:73:ae:8b brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet 192.168.2.2/24 scope global ceth1
       valid_lft forever preferred_lft forever
    inet6 fe80::8c82:d4ff:fe73:ae8b/64 scope link
       valid_lft forever preferred_lft forever
```

## 9. ns0, ns1 í†µì‹  í™•ì¸
```bash
# ì „ì²´ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ í™•ì¸
root@cgroupv1:~] ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host noprefixroute
       valid_lft forever preferred_lft forever
2: enX0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc fq_codel state UP group default qlen 1000
    link/ether 0a:fb:45:e2:59:21 brd ff:ff:ff:ff:ff:ff
    inet 172.31.45.46/20 metric 100 brd 172.31.47.255 scope global dynamic enX0
       valid_lft 3461sec preferred_lft 3461sec
    inet6 fe80::8fb:45ff:fee2:5921/64 scope link
       valid_lft forever preferred_lft forever
3: br0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default qlen 1000
    link/ether 82:0b:be:b4:c2:65 brd ff:ff:ff:ff:ff:ff
    inet 192.168.2.1/24 scope global br0
       valid_lft forever preferred_lft forever
    inet6 fe80::800b:beff:feb4:c265/64 scope link
       valid_lft forever preferred_lft forever
5: veth0@if4: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue master br0 state UP group default qlen 1000
    link/ether 96:33:19:ba:67:41 brd ff:ff:ff:ff:ff:ff link-netns ns0
    inet6 fe80::9433:19ff:feba:6741/64 scope link
       valid_lft forever preferred_lft forever
7: veth1@if6: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue master br0 state UP group default qlen 1000
    link/ether 46:ff:58:03:f2:38 brd ff:ff:ff:ff:ff:ff link-netns ns1
    inet6 fe80::44ff:58ff:fe03:f238/64 scope link
       valid_lft forever preferred_lft forever

# ns0ì˜ ceth0 ì •ìƒ í†µì‹  í™•ì¸ 
root@cgroupv1:~] ip netns exec ns0 ping -c 2 192.168.2.2
PING 192.168.2.2 (192.168.2.2) 56(84) bytes of data.
64 bytes from 192.168.2.2: icmp_seq=1 ttl=64 time=0.014 ms
64 bytes from 192.168.2.2: icmp_seq=2 ttl=64 time=0.018 ms
--- 192.168.2.2 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1042ms
rtt min/avg/max/mdev = 0.014/0.016/0.018/0.002 ms

# ns1ì˜ ceth1 ì •ìƒ í†µì‹  í™•ì¸
root@cgroupv1:~] ip netns exec ns1 ping -c 2 192.168.2.2
PING 192.168.2.2 (192.168.2.2) 56(84) bytes of data.
64 bytes from 192.168.2.2: icmp_seq=1 ttl=64 time=0.015 ms
64 bytes from 192.168.2.2: icmp_seq=2 ttl=64 time=0.019 ms
--- 192.168.2.2 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1034ms
rtt min/avg/max/mdev = 0.015/0.017/0.019/0.002 ms
```