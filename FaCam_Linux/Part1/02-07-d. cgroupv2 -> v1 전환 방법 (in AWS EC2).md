---
Index: "[[π· Tech Notes]]"
tags:
  - Linux
  - Linux/Kernel
  - cgroup
  - cgroupv1
  - cgroupv2
  - AWS/EC2
---
>[!Info] Link
>- [[02-06. cgroupμ μ΄ν•΄]]
>- [[02-07-0. (μ‹¤μµ) croupμΌλ΅ Anti Virus μ•± CPU μ‚¬μ© μ ν•]]
>- [[02-07-a. cgroup v1, v2 λΉ„κµ]]
>- [[02-07-b. apt error]]
>- [[02-07-c. μ‹¤μµ ν™κ²½ μ΄κΈ°ν™”]]


### λ¬Έμ μƒν™©
- ubuntu 24.04μ—μ„ μ κ³µν•λ” κΈ°λ³Έ cgroup versionμ΄ v2μ—¬μ„, cgroupv1μΌλ΅ μ‹¤μµμ„ μ§„ν–‰ν•λ ¤ ν–λ‹¤.
- cgroupv1μΌλ΅ λ³€κ²½μ„ μ„ν•΄μ„, kernel boot parameterλ¥Ό λ³€κ²½ν–λ‹¤.
- ν•μ§€λ§, μ¬λ¶€ν… μ΄ν›„μ—λ„ cgroupv2μ΄ μ μ§€λλ‹¤.
- κ΄€λ ¨ν•μ—¬ νΈλ¬λΈ” μν… κ³Όμ •λ“¤μ„ μ •λ¦¬ν• λ‚΄μ©μ΄λ‹¤.

---


## cgroup v2 -> v1 λ³€κ²½ λ°©λ²•

- kernel boot parameter λ³€κ²½
```sh
vi /etc/default/grub
---
# λ‹¤μμ μ¤„μ„ μ°Ύλ”λ‹¤.
GRUB_CMDLINE_LINUX_DEFAULT="quiet splash" 

# μ•„λμ™€ κ°™μ΄ λ³€κ²½ν•λ‹¤.
## λ§μ•½ λ‹¤λ¥Έ μµμ…μ΄ κ°™μ΄ μ‡λ‹¤λ©΄, μ¤νμ΄μ¤λ΅ κµ¬λ¶„ν•΄μ„ μ¶”κ°€ν•λ©΄ λλ‹¤.
GRUB_CMDLINE_LINUX_DEFAULT="quiet splash systemd.unified_cgroup_hierarchy=0"
---
```

- update μ μ©
```sh
sudo update-grub
```

- μ¬λ¶€ν…
```sh
sudo reboot
```

- μ μ© μ—¬λ¶€ ν™•μΈ
```sh
mount | grep cgroup
```



---

> λ‚λ” AWS EC2 μΈμ¤ν„΄μ¤μ—μ„ μ‹¤μµμ„ μ§„ν–‰ μ¤‘μ΄λ‹¤.
> μΈμ¤ν„΄μ¤λ¥Ό Stop/Startλ¥Ό ν–μ§€λ§, μ—¬μ „ν cgroupv2λ΅ μ μ§€λλ‹¤.
> μΌλ°μ μΈ μ„λ²„, VMμ΄ μ•„λ‹λΌ ν΄λΌμ°λ“ μΈμ¤ν„΄μ¤λ¥Ό ν™μ©ν•κΈ° λ•λ¬Έμ— μ΄λ° λ¬Έμ κ°€ λ°μƒν•λ” κ²ƒμΌλ΅ μ¶”μΈ΅ν–λ‹¤.
> μ΄λ¥Ό ν•΄κ²°ν•κΈ° μ„ν•΄ λ‹¤μμ κ³Όμ •μ„ κ±°μ³¤λ‹¤.



## TroubleShooting

### 1. μ„¤μ • μ μ© μ—¬λ¶€ ν™•μΈ
- μ‹¤μ λ΅ μ»¤λ„μ΄ μ–΄λ–¤ μµμ…μΌλ΅ λ¶€ν…λλ”μ§€ ν™•μΈν•λ‹¤.

```bash
cat /proc/cmdline
BOOT_IMAGE=/vmlinuz-6.8.0-1024-aws root=PARTUUID=a8ef6bc6-0748-47d7-a4a8-b126c21ff84c ro console=tty1 console=ttyS0 nvme_core.io_timeout=4294967295 panic=-1
```
- `systemd.unified_cgroup_hierarchy=0` μ΄ μ•λ³΄μ΄λ” κ²ƒμΌλ΅ λ³΄μ•„,
  λ³€κ²½ν–λ grub μ„¤μ •μ΄ μ μ© μ•λ κ²ƒμ„ ν™•μΈν•  μ μλ‹¤.

- μ¶”κ°€ ν™•μΈ

```sh
sudo grep GRUB_CMDLINE_LINUX_DEFAULT /boot/grub/grub.cfg
```
- μ•„λ¬΄κ²ƒλ„ μ¶λ ¥λμ§€ μ•λ” κ²ƒμ„ λ³΄μ•„, `update-grub`μ΄ μ λ€λ΅ μ μ©λμ§€ μ•μ•μμ„ ν™•μΈν–λ‹¤.


---

## 2. AWS EC2 λ¶€ν… ν”„λ΅μ„Έμ¤ μ΅°μ‚¬
- μ‹¤μµμ„ t3.micro μΈμ¤ν„΄μ¤μ—μ„ ubuntu 24.04 μ΄λ―Έμ§€λ¥Ό μ¬λ ¤μ„ μ§„ν–‰ν•κ³  μλ‹¤.

- `t3.micro`
	- `t3.micro`μ κ²½μ°, Nitro ν•μ΄νΌλ°”μ΄μ €λ¥Ό μ‚¬μ©ν•λ” μΈμ¤ν„΄μ¤μ΄λ‹¤.
	- Nitroλ” μΌλ°μ μΈ λ¶€νΈ λ©”μ»¤λ‹μ¦μ—μ„ μ‚¬μ©ν•λ” BIOS/UEFI + GRUB μμ„κ°€ μ•„λ‹, AWSκ°€ μ μ–΄ν•λ” λ¶€νΈμ¤νΈλ©μ„ μ‚¬μ©ν•λ‹¤. #μ°Έκ³  [[OS Booting Process]]

- `ubuntu 24.04 Cloud Image`
	- AWSμ—μ„ μ κ³µν•λ” EC2μ μ°λ¶„ν¬ μ΄λ―Έμ§€λ” μΌλ° isoμ™€ λ‹¬λ¦¬,
	  `cloud-init, cloud-kernel`μ„ μ‚¬μ©ν•λ‹¤. 
	  μ΄λ΅ μΈν•΄, μ»¤λ„ λ° νλΌλ―Έν„° κ΄€λ¦¬κ°€ cloud-initμ— μ„μ„λ λ¶€λ¶„μ΄ μλ‹¤λ” κ²ƒμ„ ν™•μΈ
	- μ¦‰, `/etc/default/grub`μ—μ„ νλΌλ―Έν„°λ¥Ό λ³€κ²½ν•κ³  `update-grub`μ„ ν†µν•΄μ„ μ μ©ν•λ”λΌλ„ λ°μ λμ§€ μ•κ±°λ‚, EC2 λ¶€ν… κ³Όμ •μ—μ„ AWSμ EC2Launch/init μ‹μ¤ν…μ΄ overrieν•  μ μλ‹¤.


λ”°λΌμ„, ν΄λΌμ°λ“ μΈμ¤ν„΄μ¤μ μ»¤λ„ νλΌλ―Έν„°λ¥Ό λ³€κ²½ν•λ ¤λ©΄, κΈ°μ΅΄μ `grub` νλΌλ―Έν„°λ¥Ό λ³€κ²½ν•λ” κ²ƒμ΄ μ•„λ‹λΌ,  ν΄λΌμ°λ“ λ¶€ν… μ„¤μ • νμΌμ„ μ°Ύμ•„μ„ νλΌλ―Έν„°λ¥Ό λ³€κ²½ν•΄μ•Ό ν•λ‹¤.


---


## ν΄λΌμ°λ“ λ¶€ν… μ„¤μ • νμΌ ν™•μΈ λ° νΈμ§‘
- λ‹¤μμ€ κ³µμ‹ Ubuntu EC2 AMIκ°€ μ‚¬μ©ν•λ”  `/etc/default/grub.d/*.cfg` μ„¤μ •μ„ μ§μ ‘ μμ •ν•λ” λ°©λ²•μ΄λ‹¤.

### 1. κ΄€λ ¨ μ„¤μ • ν™•μΈ

```bash
ls /etc/default/grub.d
40-force-partuuid.cfg
50-cloudimg-settings.cfg
```

### 2. μ„¤μ • νμΌ νΈμ§‘

```bash
sudo vi /etc/default/grub.d/50-cloudimg-settings.cfg
---
# 1) λ‹¤μ λ‚΄μ©μ„ μ°Ύλ”λ‹¤.
GRUB_CMDLINE_LINUX_DEFAULT="quiet splash"

## 2) λ‹¤μκ³Ό κ°™μ΄ λ³€κ²½ν•λ‹¤.
GRUB_CMDLINE_LINUX_DEFAULT="quiet splash systemd.unified_cgroup_hierarchy=0"

---
```

### 3. grub μ—…λ°μ΄νΈ

```bash
sudo update-grub
```

### 4. μ¬λ¶€ν… ν›„ μ μ© μ—¬λ¶€ ν™•μΈ

```bash
sudo reboot

# μ¬λ¶€ν… ν›„ μ μ© ν™•μΈ
cat /proc/cmdline
```


---

## μ •λ¦¬
- AWS EC2 Ubuntu 24.04 μ΄λ―Έμ§€λ” `cloud-init` κ³Όμ •μ—μ„  `50-cloudimg-settings.cfg` νμΌμ„ ν†µν•΄ GRUB λ¶€ν… νλΌλ―Έν„°λ¥Ό μ„¤μ •ν•λ‹¤.
- μ΄λ΅ μΈν•΄, κΈ°μ΅΄ `/etc/default/grub`μ μ„¤μ •μ€ λ¬΄μ‹λκ³ , 
  μ‹¤μ  λ¶€ν… νλΌλ―Έν„°λ” `50-cloudimg-settings.cfg`μ—μ„λ§ μ μ©λλ‹¤.
- λ”°λΌμ„, cgroup versionμ„ λ³€κ²½μ„ μ„ν•΄μ„
  `/etc/default/grub.d/50-cloudimg-settings.cfg`μ—μ„ 
  μ»¤λ„ λ¶€νΈ νλΌλ―Έν„°μΈ `GRUB_CMDLINE_LINUX_DEFAULT`μ—
  `"systemd.unified_cgroup_hierarchy=0"`λ¥Ό μ¶”κ°€ν•΄μ¤μ•Ό ν•λ‹¤.